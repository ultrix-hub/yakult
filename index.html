<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è²©å£²å“¡ã‚µãƒãƒ¼ãƒˆ (Sales Assist)</title>
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root {
            --primary-color: #d32f2f; /* ãƒ¤ã‚¯ãƒ«ãƒˆé¢¨ã®èµ¤ */
            --primary-light: #ff6659;
            --primary-dark: #9a0007;
            --accent-color: #1976d2;
            --bg-color: #f5f5f5;
            --card-bg: #ffffff;
            --text-main: #333333;
            --text-sub: #666666;
            --border-color: #e0e0e0;
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-size: 16px;
            padding-bottom: calc(70px + var(--safe-area-bottom)); /* ãƒœãƒˆãƒ ãƒŠãƒ“ã®åˆ† */
        }

        /* å…±é€šUIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 16px;
            border-radius: 8px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.2s;
            font-size: 1rem;
        }
        .btn:active { opacity: 0.7; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-secondary { background-color: white; color: var(--text-main); border: 1px solid var(--border-color); }
        .btn-danger { background-color: #d32f2f; color: white; }
        .btn-block { width: 100%; }
        .btn-icon { padding: 8px; border-radius: 50%; }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .input-group { margin-bottom: 16px; }
        .input-label { display: block; margin-bottom: 6px; font-weight: bold; font-size: 0.9rem; color: var(--text-sub); }
        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            background: #fff;
        }
        .form-control:focus { outline: 2px solid var(--primary-color); border-color: transparent; }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 16px;
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        header h1 { font-size: 1.2rem; }

        /* ãƒœãƒˆãƒ ãƒŠãƒ“ */
        nav.bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: white;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            padding-bottom: var(--safe-area-bottom);
            z-index: 1000;
        }
        .nav-item {
            flex: 1;
            text-align: center;
            padding: 10px 0;
            color: var(--text-sub);
            font-size: 0.7rem;
            cursor: pointer;
            position: relative;
        }
        .nav-item .material-icons { display: block; font-size: 24px; margin-bottom: 4px; }
        .nav-item.active { color: var(--primary-color); }
        
        .badge-pulse {
            position: absolute; top: 5px; right: 25%;
            background: var(--primary-color); color: white;
            border-radius: 50%; width: 18px; height: 18px;
            font-size: 10px; display: flex; align-items: center; justify-content: center;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(211, 47, 47, 0); } 100% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0); } }

        /* ç”»é¢åˆ‡ã‚Šæ›¿ãˆ */
        .page { display: none; padding: 16px; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ --- */
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
        .stat-card { text-align: center; padding: 20px 10px; }
        .stat-value { font-size: 1.8rem; font-weight: bold; color: var(--primary-color); }
        .stat-label { font-size: 0.8rem; color: var(--text-sub); }
        .history-list .history-item { 
            padding: 12px 0; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; 
        }
        .history-item:last-child { border-bottom: none; }

        /* --- è¨ªå•å…¥åŠ› --- */
        .customer-select-area { max-height: 200px; overflow-y: auto; background: #fff; border: 1px solid #ddd; border-radius: 8px; margin-top: 5px; display: none; }
        .customer-option { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; }
        .customer-option:hover { background: #f9f9f9; }
        
        .product-list-item {
            display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee;
        }
        .qty-control { display: flex; align-items: center; gap: 10px; }
        .qty-btn { width: 36px; height: 36px; border-radius: 50%; border: 1px solid var(--border-color); background: white; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; }
        .qty-val { width: 30px; text-align: center; font-weight: bold; }
        
        .total-bar {
            position: fixed; bottom: calc(60px + var(--safe-area-bottom)); left: 0; right: 0;
            background: var(--primary-color); color: white; padding: 12px 16px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1); font-weight: bold;
        }

        /* ã‚¢ãƒ©ãƒ¼ãƒˆãƒ»æ›œæ—¥é¸æŠ */
        .alert-card { border: 2px solid var(--primary-color) !important; background-color: #fff5f5 !important; }
        .day-filter-container { display: flex; gap: 8px; overflow-x: auto; margin-bottom: 12px; padding-bottom: 4px; }
        .day-chip { padding: 6px 12px; background: white; border: 1px solid var(--border-color); border-radius: 20px; font-size: 0.8rem; white-space: nowrap; cursor: pointer; }
        .day-chip.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }

        /* --- ãƒã‚¹ã‚¿ç®¡ç† --- */
        .fab {
            position: fixed; bottom: calc(70px + var(--safe-area-bottom)); right: 20px;
            width: 56px; height: 56px; background: var(--primary-color); color: white;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; z-index: 90;
        }
        .list-item-action { display: flex; gap: 10px; }

        /* --- ãƒ¬ãƒãƒ¼ãƒˆ --- */
        .report-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; margin-top: 10px; }
        .report-table th, .report-table td { padding: 8px; text-align: left; border-bottom: 1px solid #eee; }
        .report-table th { background: #f9f9f9; font-weight: bold; }
        .report-summary { display: flex; justify-content: space-between; background: #eee; padding: 10px; border-radius: 8px; font-weight: bold; margin-bottom: 10px; flex-wrap: wrap; gap: 5px; }

        /* ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ */
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        .text-muted { color: var(--text-sub); }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; background: #eee; }
        .badge-success { background: #e8f5e9; color: #2e7d32; }
        .badge-warning { background: #fff3e0; color: #ef6c00; }
        
        /* å°åˆ·ç”¨ */
        @media print {
            .bottom-nav, .fab, .no-print { display: none !important; }
            body { padding-bottom: 0; background: white; }
            .card { box-shadow: none; border: 1px solid #ccc; }
            .page { display: block !important; }
            /* å°åˆ·æ™‚ã¯ãƒ¬ãƒãƒ¼ãƒˆã®ã¿è¡¨ç¤ºãªã©ã®åˆ¶å¾¡ãŒå¿…è¦ã ãŒç°¡æ˜“çš„ã«ã¯å…¨ã¦å‡ºã‚‹ */
            #page-home, #page-entry, #page-master, #page-settings { display: none !important; }
            #page-report { display: block !important; }
        }
    </style>
</head>
<body>

<!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
<header>
    <h1 id="header-title">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
    <div id="header-date" style="font-size: 0.8rem;"></div>
</header>

<!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
<main>
    <!-- 1. ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
    <section id="page-home" class="page active">
        <div class="stat-grid">
            <div class="card stat-card">
                <div class="stat-value" id="dash-today-visits">0</div>
                <div class="stat-label">ä»Šæ—¥ã®è¨ªå•</div>
            </div>
            <div class="card stat-card">
                <div class="stat-value">Â¥<span id="dash-today-sales">0</span></div>
                <div class="stat-label">ä»Šæ—¥ã®è²©å£²é¡</div>
            </div>
            <div class="card stat-card">
                <div class="stat-value">Â¥<span id="dash-today-collections">0</span></div>
                <div class="stat-label">ä»Šæ—¥ã®é›†é‡‘é¡</div>
            </div>
            <div class="card stat-card">
                <div class="stat-value" id="dash-customers">0</div>
                <div class="stat-label">ç™»éŒ²é¡§å®¢æ•°</div>
            </div>
        </div>

        <h3>ç›´è¿‘ã®æ´»å‹•</h3>
        <div class="card">
            <div id="dash-history-list" class="history-list">
                <!-- JSã§æŒ¿å…¥ -->
                <div class="text-center text-muted" style="padding: 20px;">å±¥æ­´ãªã—</div>
            </div>
        </div>
        
        <button class="btn btn-primary btn-block" onclick="router.navigate('entry')">
            <span class="material-icons" style="margin-right: 8px;">add_circle</span>
            è¨ªå•è¨˜éŒ²ã‚’å…¥åŠ›ã™ã‚‹
        </button>
    </section>

    <!-- 2. è¨ªå•è¨˜éŒ²å…¥åŠ› -->
    <section id="page-entry" class="page">
        <div id="rusutaku-alert-area"></div>

        <div class="card">
            <div class="input-group">
                <label class="input-label">æ—¥æ™‚</label>
                <div style="display:flex; gap:8px;">
                    <input type="datetime-local" id="entry-date" class="form-control" onchange="visitManager.onDateChange()">
                    <button class="btn btn-secondary btn-sm" onclick="visitManager.applyCurrentDate()">ä»Šæ—¥</button>
                </div>
            </div>
            
            <label class="input-label">æ›œæ—¥ã§çµã‚Šè¾¼ã¿</label>
            <div class="day-filter-container">
                <div class="day-chip" data-day="Monday" onclick="visitManager.filterByDay('Monday')">æœˆ</div>
                <div class="day-chip" data-day="Tuesday" onclick="visitManager.filterByDay('Tuesday')">ç«</div>
                <div class="day-chip" data-day="Wednesday" onclick="visitManager.filterByDay('Wednesday')">æ°´</div>
                <div class="day-chip" data-day="Thursday" onclick="visitManager.filterByDay('Thursday')">æœ¨</div>
                <div class="day-chip" data-day="Friday" onclick="visitManager.filterByDay('Friday')">é‡‘</div>
                <div class="day-chip" data-day="Saturday" onclick="visitManager.filterByDay('Saturday')">åœŸ</div>
                <div class="day-chip" data-day="Sunday" onclick="visitManager.filterByDay('Sunday')">æ—¥</div>
            </div>

            <div class="input-group" style="position: relative;">
                <label class="input-label">é¡§å®¢ (å¿…é ˆ)</label>
                <input type="text" id="entry-customer-search" class="form-control" placeholder="åå‰ã§æ¤œç´¢ã¾ãŸã¯æ›œæ—¥é¸æŠ..." autocomplete="off">
                <input type="hidden" id="entry-customer-id">
                <div id="entry-customer-results" class="customer-select-area"></div>
                <div id="entry-customer-selected-display" style="margin-top:8px; font-weight:bold; color:var(--primary-color); display:flex; justify-content:space-between; align-items:center;">
                    <span id="selected-customer-name"></span>
                    <button id="btn-map-entry" class="btn btn-secondary btn-sm" style="display:none;"><span class="material-icons" style="font-size:16px;">map</span> åœ°å›³</button>
                </div>
                <div id="selected-customer-ar" style="font-size:0.9rem; color:#d32f2f; font-weight:bold; margin-top:4px;"></div>
                <div id="selected-customer-office" style="font-size:0.8rem; color:var(--accent-color); font-weight:bold; margin-top:2px;"></div>
                <div id="selected-customer-memo" style="font-size:0.8rem; color:var(--text-sub); margin-top:4px;"></div>
            </div>

            <div class="input-group">
                <label class="input-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                <div style="display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px;">
                    <button type="button" class="btn btn-secondary status-btn active" data-val="sold">è²©å£²</button>
                    <button type="button" class="btn btn-secondary status-btn" data-val="absent">ç•™å®ˆå®…</button>
                    <button type="button" class="btn btn-secondary status-btn" data-val="talk">ä¼šè©±ã®ã¿</button>
                    <button type="button" class="btn btn-secondary status-btn" data-val="next">æ¬¡å›äºˆç´„</button>
                </div>
                <input type="hidden" id="entry-status" value="sold">
            </div>
        </div>

        <div class="card" id="entry-products-section">
            <h3 style="margin-bottom: 10px;">è²©å£²å•†å“</h3>
            <div id="entry-product-list">
                <!-- JSã§å•†å“ãƒªã‚¹ãƒˆã‚’å±•é–‹ -->
            </div>
        </div>

        <div class="card" id="entry-payment-section">
            <div class="input-group">
                <label class="input-label">æ”¯æ‰•æ–¹æ³•</label>
                <select id="entry-payment-method" class="form-control" onchange="visitManager.updateTotal()">
                    <option value="cash">ç¾é‡‘</option>
                    <option value="paypay">PayPay</option>
                    <option value="credit">ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ</option>
                    <option value="prepaid">å‰æ‰•ã„æ¶ˆåŒ–</option>
                    <option value="monthly">å£²æ›(æœˆæœ«æœˆæ¥µ)</option>
                </select>
            </div>
            <div class="input-group">
                <label class="input-label">ä»Šå›ã®é›†é‡‘é¡ (å®Ÿéš›ã«å—ã‘å–ã£ãŸç¾é‡‘ç­‰)</label>
                <input type="number" id="entry-collection-amount" class="form-control" placeholder="0">
                <p class="text-muted" style="font-size: 0.75rem; margin-top:4px;">â€»éå»åˆ†ã®é›†é‡‘ã‚„å‰å—é‡‘ãŒã‚ã‚‹å ´åˆã¯é‡‘é¡ã‚’èª¿æ•´ã—ã¦ãã ã•ã„</p>
            </div>
        </div>

        <div class="card">
            <div class="input-group">
                <label class="input-label">ãƒ¡ãƒ¢</label>
                <textarea id="entry-note" class="form-control" rows="2"></textarea>
            </div>
        </div>

        <!-- ã‚¹ãƒšãƒ¼ã‚¹èª¿æ•´ -->
        <div style="height: 60px;"></div>

        <!-- åˆè¨ˆãƒãƒ¼ -->
        <div class="total-bar" id="entry-total-bar">
            <div id="entry-total-info">è²©å£²è¨ˆ: Â¥<span id="entry-total-price">0</span></div>
            <button class="btn" style="background: white; color: var(--primary-color);" onclick="visitManager.save()">ä¿å­˜</button>
        </div>
    </section>

    <!-- 3. ãƒã‚¹ã‚¿ç®¡ç† -->
    <section id="page-master" class="page">
        <div style="display: flex; gap: 10px; margin-bottom: 16px;">
            <button class="btn btn-primary" id="tab-master-customer" style="flex:1;" onclick="masterManager.switchTab('customer')">é¡§å®¢ä¸€è¦§</button>
            <button class="btn btn-secondary" id="tab-master-product" style="flex:1;" onclick="masterManager.switchTab('product')">å•†å“ä¸€è¦§</button>
        </div>

        <!-- é¡§å®¢ãƒªã‚¹ãƒˆ -->
        <div id="master-customer-view">
            <div class="input-group">
                <input type="text" id="master-customer-search" class="form-control" placeholder="é¡§å®¢æ¤œç´¢..." oninput="masterManager.renderCustomers()">
            </div>
            <div id="master-customer-list"></div>
        </div>

        <!-- å•†å“ãƒªã‚¹ãƒˆ -->
        <div id="master-product-view" style="display:none;">
            <div id="master-product-list"></div>
        </div>

        <!-- æ–°è¦è¿½åŠ ãƒœã‚¿ãƒ³ -->
        <div class="fab" onclick="masterManager.openModal()">
            <span class="material-icons">add</span>
        </div>
    </section>

    <!-- 4. ãƒ¬ãƒãƒ¼ãƒˆ -->
    <section id="page-report" class="page">
        <div class="card no-print">
            <div class="input-group">
                <label class="input-label">é›†è¨ˆå˜ä½</label>
                <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                    <button class="btn btn-primary btn-sm rep-type-btn" data-type="day" onclick="reportManager.setType('day')">æ—¥æ¬¡</button>
                    <button class="btn btn-secondary btn-sm rep-type-btn" data-type="week" onclick="reportManager.setType('week')">é€±æ¬¡</button>
                    <button class="btn btn-secondary btn-sm rep-type-btn" data-type="month" onclick="reportManager.setType('month')">æœˆæ¬¡</button>
                </div>
                <label class="input-label">å¯¾è±¡æ—¥/æœˆ</label>
                <div style="display: flex; gap: 10px;">
                    <input type="date" id="report-date" class="form-control" onchange="reportManager.render()">
                    <input type="month" id="report-month" class="form-control" style="display:none;" onchange="reportManager.render()">
                </div>
            </div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-secondary btn-sm" onclick="reportManager.exportCSV()">
                    <span class="material-icons" style="font-size: 16px;">download</span> CSVå‡ºåŠ›
                </button>
                <button class="btn btn-secondary btn-sm" onclick="window.print()">
                    <span class="material-icons" style="font-size: 16px;">print</span> å°åˆ·
                </button>
            </div>
        </div>

        <div id="report-content">
            <h2 class="text-center" style="margin-bottom: 20px;"><span id="report-title-label"></span> ãƒ¬ãƒãƒ¼ãƒˆ</h2>
            <div class="text-right text-muted" style="font-size: 0.8rem; margin-bottom: 10px;">æ‹…å½“: <span id="report-staff-name"></span></div>

            <div class="report-summary">
                <div>è¨ªå•: <span id="rep-visit-count">0</span></div>
                <div>è²©å£²é«˜: Â¥<span id="rep-total-sales">0</span></div>
                <div>é›†é‡‘é«˜: Â¥<span id="rep-total-collections">0</span></div>
            </div>

            <!-- æœˆæ¬¡é™å®šè©³ç´° -->
            <div id="rep-monthly-extra" style="display:none;">
                <h4 style="margin-top: 20px; border-bottom: 2px solid #ddd;">æ›œæ—¥åˆ¥è¨ªå•çµ±è¨ˆ (æœˆé–“åˆè¨ˆ)</h4>
                <table class="report-table" id="rep-day-stat-table">
                    <thead><tr><th>æ›œæ—¥</th><th>è¨ªå•ä»¶æ•°</th><th>æœˆæ¥µä»¶æ•°</th><th>ä»–æ”¯æ‰•ä»¶æ•°</th><th>æœªè³¼å…¥</th></tr></thead>
                    <tbody></tbody>
                </table>
                <h4 style="margin-top: 20px; border-bottom: 2px solid #ddd;">ç‰¹å®šå•†å“ã‚«ãƒ†ã‚´ãƒªçµ±è¨ˆ</h4>
                <table class="report-table" id="rep-cat-stat-table">
                    <thead><tr><th>å•†å“ã‚«ãƒ†ã‚´ãƒª</th><th>æœˆæ¥µä»¶æ•°</th><th>ä»–æ”¯æ‰•ä»¶æ•°</th></tr></thead>
                    <tbody></tbody>
                </table>
                <h4 style="margin-top: 20px; border-bottom: 2px solid #ddd;">äº‹æ¥­æ‰€åˆ¥çµ±è¨ˆ</h4>
                <table class="report-table" id="rep-office-table">
                    <thead>
                        <tr><th>äº‹æ¥­æ‰€å</th><th>è¨ªå•</th><th>æœˆæ¥µ</th><th>ç¾é‡‘</th><th>PP</th><th>Y400</th><th>Y1000</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <h4 style="margin-top: 20px; border-bottom: 2px solid #ddd;">è²©å£²å†…è¨³ (æ”¯æ‰•æ–¹æ³•åˆ¥)</h4>
            <table class="report-table" id="rep-pay-table">
                <thead><tr><th>æ”¯æ‰•æ–¹æ³•</th><th class="text-right">è²©å£²é¡</th><th class="text-right">å†…:é›†é‡‘é¡</th></tr></thead>
                <tbody></tbody>
            </table>

            <h4 style="margin-top: 20px; border-bottom: 2px solid #ddd;">å•†å“åˆ¥é›†è¨ˆ</h4>
            <table class="report-table" id="rep-prod-table">
                <thead><tr><th>å•†å“å</th><th class="text-right">æ•°é‡</th><th class="text-right">é‡‘é¡</th></tr></thead>
                <tbody></tbody>
            </table>

            <h4 style="margin-top: 20px; border-bottom: 2px solid #ddd;">é¡§å®¢åˆ¥è©³ç´°</h4>
            <table class="report-table" id="rep-cust-table">
                <thead><tr><th>é¡§å®¢å</th><th class="text-right">è²©å£²é¡</th><th class="text-right">é›†é‡‘é¡</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </section>

    <!-- 5. è¨­å®š -->
    <section id="page-settings" class="page">
        <div class="card">
            <h3>åŸºæœ¬è¨­å®š</h3>
            <div class="input-group">
                <label class="input-label">æ‹…å½“è€…å / ä¼šç¤¾å</label>
                <input type="text" id="setting-staff-name" class="form-control">
            </div>
            <button class="btn btn-primary" onclick="settingsManager.saveBasic()">ä¿å­˜</button>
        </div>

        <div class="card">
            <h3>ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
            <p class="text-muted" style="font-size: 0.9rem; margin-bottom: 10px;">
                ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆJSONå½¢å¼ï¼‰ã‚’ä¿å­˜ã—ãŸã‚Šã€å¾©å…ƒã—ãŸã‚Šã§ãã¾ã™ã€‚
            </p>
            <div style="display: flex; gap: 10px; margin-bottom: 16px;">
                <button class="btn btn-secondary" onclick="settingsManager.exportData()">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜</button>
                <label class="btn btn-secondary" style="cursor: pointer;">
                    å¾©å…ƒ (èª­è¾¼)
                    <input type="file" accept=".json" style="display: none;" onchange="settingsManager.importData(this)">
                </label>
            </div>
            
            <hr style="margin: 16px 0;">
            
            <button class="btn btn-danger btn-block" onclick="settingsManager.clearAllData()">
                <span class="material-icons" style="margin-right: 8px;">delete_forever</span>
                å…¨ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã—ã¦ãƒªã‚»ãƒƒãƒˆ
            </button>
        </div>
    </section>
</main>

<!-- ãƒœãƒˆãƒ ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
<nav class="bottom-nav">
    <div class="nav-item active" onclick="router.navigate('home')">
        <span class="material-icons">dashboard</span>
        ãƒ›ãƒ¼ãƒ 
    </div>
    <div class="nav-item" onclick="router.navigate('entry')">
        <span class="material-icons">edit_note</span>
        è¨ªå•
        <span id="alert-badge" class="badge-pulse" style="display:none;">0</span>
    </div>
    <div class="nav-item" onclick="router.navigate('master')">
        <span class="material-icons">people</span>
        ãƒã‚¹ã‚¿
    </div>
    <div class="nav-item" onclick="router.navigate('report')">
        <span class="material-icons">assessment</span>
        ãƒ¬ãƒãƒ¼ãƒˆ
    </div>
    <div class="nav-item" onclick="router.navigate('settings')">
        <span class="material-icons">settings</span>
        è¨­å®š
    </div>
</nav>

<!-- ãƒã‚¹ã‚¿ç·¨é›†ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« (ç°¡æ˜“) -->
<div id="master-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; align-items:center; justify-content:center;">
    <div class="card" style="width: 90%; max-width: 400px; max-height: 90vh; overflow-y: auto;">
        <h3 id="modal-title" style="margin-bottom: 16px;">ç·¨é›†</h3>
        <input type="hidden" id="modal-id">
        <input type="hidden" id="modal-type">
        
        <div id="modal-fields"></div>
        
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="btn btn-secondary" style="flex:1" onclick="masterManager.closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button class="btn btn-primary" style="flex:1" onclick="masterManager.saveFromModal()">ä¿å­˜</button>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
<script>
/**
 * ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚¯ãƒ©ã‚¹
 */
const Store = {
    key: 'sales_assist_data_v1',
    firestoreCollection: 'appData',
    firestoreDocId: 'default',
    db: null,
    data: {
        customers: [],
        products: [],
        visits: [],
        settings: { staffName: 'æ‹…å½“è€…' }
    },

    async init() {
        const firebaseConfig = {
            apiKey: "AIzaSyAdqFw1aPlYDLfilX1n41GNrgsLmLevA2Y",
            authDomain: "yakult-dailyreport.firebaseapp.com",
            projectId: "yakult-dailyreport",
            storageBucket: "yakult-dailyreport.firebasestorage.app",
            messagingSenderId: "916854952671",
            appId: "1:916854952671:web:631124d7cbbf2a6d4f8f6a"
        };

        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            this.db = firebase.firestore();
            const doc = await this.db.collection(this.firestoreCollection).doc(this.firestoreDocId).get();
            if (doc.exists) {
                this.data = doc.data();
                localStorage.setItem(this.key, JSON.stringify(this.data));
                return;
            }
        } catch (err) {
            console.error('Firestoreèª­ã¿è¾¼ã¿å¤±æ•—ã€‚localStorageã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã—ã¾ã™ã€‚', err);
        }

        const json = localStorage.getItem(this.key);
        if (json) {
            this.data = JSON.parse(json);
            this.save(); // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’Firestoreã¸åŒæœŸ
        } else {
            this.seed(); // åˆæœŸãƒ‡ãƒ¼ã‚¿æŠ•å…¥
        }
    },

    save() {
        localStorage.setItem(this.key, JSON.stringify(this.data));
        if (!this.db) return;
        this.db
            .collection(this.firestoreCollection)
            .doc(this.firestoreDocId)
            .set(this.data)
            .catch(err => console.error('Firestoreä¿å­˜å¤±æ•—', err));
    },

    seed() {
        // åˆæœŸãƒ‡ãƒ¼ã‚¿ï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰
        this.data.customers = [
            { id: 'c1', name: 'å±±ç”° å¤ªéƒ', phone: '090-1111-2222', address: '1ä¸ç›®', visitDay: 'Monday', defaultPayment: 'cash', isActive: true, memo: 'ç„é–¢å‰ã«ç½®ã', office: '', isOnDemand: false },
            { id: 'c2', name: 'éˆ´æœ¨ èŠ±å­', phone: '090-3333-4444', address: '2ä¸ç›®', visitDay: 'Tuesday', defaultPayment: 'paypay', isActive: true, memo: '', office: 'â—‹â—‹å•†äº‹', isOnDemand: false },
            { id: 'c3', name: 'ä½è—¤ å¥', phone: '', address: 'ãƒãƒ³ã‚·ãƒ§ãƒ³A', visitDay: 'Wednesday', defaultPayment: 'monthly', isActive: true, memo: 'å®…é…ãƒœãƒƒã‚¯ã‚¹ä¸å¯', office: '', isOnDemand: false },
            { id: 'c4', name: 'ç”°ä¸­ ç¾å’²', phone: '', address: '', visitDay: 'Thursday', defaultPayment: 'cash', isActive: true, memo: '', office: 'â–³â–³ãƒ“ãƒ«', isOnDemand: true },
            { id: 'c5', name: 'æ°´ç”°æ§˜', phone: '', address: '', visitDay: 'Monday', defaultPayment: 'monthly', isActive: true, memo: '', office: '', isOnDemand: false }
        ];
        this.data.products = [
            { id: 'p1', name: 'Yakult1000', price: 130, isActive: true, category: 'Y1000' },
            { id: 'p2', name: 'Newãƒ¤ã‚¯ãƒ«ãƒˆ', price: 40, isActive: true, category: 'Y400' },
            { id: 'p3', name: 'ã‚¸ãƒ§ã‚¢', price: 110, isActive: true, category: 'OTHER' },
            { id: 'p4', name: 'ãƒŸãƒ«ãƒŸãƒ«', price: 100, isActive: true, category: 'OTHER' },
            { id: 'p5', name: 'ã‚½ãƒ•ãƒ¼ãƒ«', price: 100, isActive: true, category: 'OTHER' }
        ];
        this.data.visits = [];
        this.save();
    },

    // UUIDç”Ÿæˆç°¡æ˜“ç‰ˆ
    generateId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }
};

/**
 * ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
 */
const Utils = {
    formatDate(dateStr) {
        if (!dateStr) return '';
        const d = new Date(dateStr);
        return `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`;
    },
    formatDateYMD(date) {
        return date.toISOString().split('T')[0];
    },
    formatMoney(num) {
        return (num || 0).toLocaleString();
    },
    getWeekRange(date) {
        const d = new Date(date);
        const day = d.getDay();
        const diff = d.getDate() - day + (day === 0 ? -6 : 1); // æœˆæ›œæ—¥é–‹å§‹
        const start = new Date(d.setDate(diff));
        const end = new Date(d.setDate(diff + 6));
        return { start: start.toISOString().split('T')[0], end: end.toISOString().split('T')[0] };
    },
    getDayName(dateStr) {
        const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        return days[new Date(dateStr).getDay()];
    },
    getPrevBizDay(dateStr) {
        const d = new Date(dateStr);
        const day = d.getDay();
        const sub = (day === 1) ? 3 : 1; // æœˆæ›œãªã‚‰3æ—¥å‰(é‡‘æ›œ)ã€ãã‚Œä»¥å¤–ã¯1æ—¥å‰
        d.setDate(d.getDate() - sub);
        return d.toISOString().split('T')[0];
    }
};

/**
 * ãƒ«ãƒ¼ã‚¿ãƒ¼ï¼ˆç”»é¢é·ç§»ï¼‰
 */
const router = {
    current: 'home',
    navigate(pageId) {
        this.current = pageId;
        // ãƒšãƒ¼ã‚¸è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
        document.getElementById(`page-${pageId}`).classList.add('active');
        
        // ãƒŠãƒ“ãƒã‚¤ãƒ©ã‚¤ãƒˆ
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        const navs = document.querySelectorAll('.nav-item');
        if (pageId === 'home') navs[0].classList.add('active');
        if (pageId === 'entry') navs[1].classList.add('active');
        if (pageId === 'master') navs[2].classList.add('active');
        if (pageId === 'report') navs[3].classList.add('active');
        if (pageId === 'settings') navs[4].classList.add('active');

        // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¿ã‚¤ãƒˆãƒ«æ›´æ–°
        const titles = {
            home: 'ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰',
            entry: 'è¨ªå•è¨˜éŒ²',
            master: 'ãƒã‚¹ã‚¿ç®¡ç†',
            report: 'ãƒ¬ãƒãƒ¼ãƒˆ',
            settings: 'è¨­å®š'
        };
        document.getElementById('header-title').innerText = titles[pageId];

        // å„ãƒšãƒ¼ã‚¸åˆæœŸåŒ–å‡¦ç†
        if (pageId === 'home') dashboard.render();
        if (pageId === 'entry') visitManager.initForm();
        if (pageId === 'master') masterManager.renderCustomers();
        if (pageId === 'report') reportManager.init();
        if (pageId === 'settings') settingsManager.init();
    }
};

/**
 * ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ©Ÿèƒ½
 */
const dashboard = {
    render() {
        const today = new Date().toISOString().split('T')[0];
        
        let todayVisits = 0;
        let todaySales = 0;
        let todayCollections = 0;

        const sortedVisits = [...Store.data.visits].sort((a,b) => b.timestamp - a.timestamp);

        sortedVisits.forEach(v => {
            const date = v.dateStr;
            if (date === today) {
                todayVisits++;
                const sales = v.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                todaySales += sales;
                todayCollections += (v.collectionAmount || 0);
            }
        });

        document.getElementById('dash-today-visits').innerText = todayVisits;
        document.getElementById('dash-today-sales').innerText = Utils.formatMoney(todaySales);
        document.getElementById('dash-today-collections').innerText = Utils.formatMoney(todayCollections);
        document.getElementById('dash-customers').innerText = Store.data.customers.filter(c => c.isActive).length;

        const historyList = document.getElementById('dash-history-list');
        historyList.innerHTML = '';
        if (sortedVisits.length === 0) {
            historyList.innerHTML = '<div class="text-center text-muted" style="padding: 20px;">å±¥æ­´ãªã—</div>';
        } else {
            sortedVisits.slice(0, 5).forEach(v => {
                const customer = Store.data.customers.find(c => c.id === v.customerId);
                const name = customer ? customer.name : 'ä¸æ˜ãªé¡§å®¢';
                const total = v.items.reduce((s, i) => s + i.price * i.quantity, 0);
                const statusMap = { sold: 'è²©å£²', absent: 'ä¸åœ¨', talk: 'ä¼šè©±', next: 'äºˆç´„' };
                
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML = `
                    <div>
                        <div style="font-weight:bold;">${name}</div>
                        <div style="font-size:0.8rem; color:#666;">${Utils.formatDate(v.timestamp)} <span class="badge">${statusMap[v.status]}</span></div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-weight:bold; color:var(--primary-color);">${total > 0 ? 'Â¥'+Utils.formatMoney(total) : ''}</div>
                        <div style="font-size:0.7rem; color:#888;">é›†é‡‘: Â¥${Utils.formatMoney(v.collectionAmount)}</div>
                    </div>
                `;
                div.onclick = () => { if(confirm('ã“ã®å±¥æ­´ã‚’ã‚‚ã¨ã«å†å…¥åŠ›ã—ã¾ã™ã‹ï¼Ÿ')) visitManager.reEnter(v); };
                historyList.appendChild(div);
            });
        }
        visitManager.updateNavAlerts();
    }
};

/**
 * è¨ªå•è¨˜éŒ²æ©Ÿèƒ½
 */
const visitManager = {
    selectedProducts: {}, 

    initForm() {
        const now = new Date();
        const localIso = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
        document.getElementById('entry-date').value = localIso;

        document.getElementById('entry-customer-search').value = '';
        document.getElementById('entry-customer-id').value = '';
        document.getElementById('selected-customer-name').innerText = '';
        document.getElementById('selected-customer-memo').innerText = '';
        document.getElementById('selected-customer-ar').innerText = '';
        document.getElementById('selected-customer-office').innerText = '';
        document.getElementById('btn-map-entry').style.display = 'none';
        document.getElementById('entry-customer-selected-display').style.display = 'none';
        document.getElementById('entry-note').value = '';
        document.getElementById('entry-collection-amount').value = '';
        this.selectedProducts = {};
        
        document.querySelectorAll('.status-btn').forEach(b => b.classList.remove('active', 'btn-primary', 'btn-secondary'));
        document.querySelectorAll('.status-btn').forEach(b => {
            if (b.dataset.val === 'sold') {
                b.classList.add('active', 'btn-primary');
            } else {
                b.classList.add('btn-secondary');
            }
        });
        document.getElementById('entry-status').value = 'sold';
        document.getElementById('entry-products-section').style.display = 'block';
        document.getElementById('entry-payment-section').style.display = 'block';
        document.getElementById('entry-total-bar').style.display = 'flex';
        document.getElementById('entry-total-info').style.visibility = 'visible';

        this.renderProductList();
        this.updateTotal();
        this.setupCustomerSearch();
        this.onDateChange();
    },

    applyCurrentDate() {
        const now = new Date();
        const localIso = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
        document.getElementById('entry-date').value = localIso;
        this.onDateChange();
    },

    onDateChange() {
        const dateVal = document.getElementById('entry-date').value;
        const todayStr = dateVal.split('T')[0];
        const dayName = Utils.getDayName(todayStr);
        this.filterByDay(dayName);
        this.renderAlerts(todayStr);
        this.updateNavAlerts();
    },

    renderAlerts(todayStr) {
        const alertArea = document.getElementById('rusutaku-alert-area');
        alertArea.innerHTML = '';
        const prevBizDay = Utils.getPrevBizDay(todayStr);
        
        const alertedCustomers = Store.data.customers.filter(c => c.isActive && c.absentAlert && c.absentDate === prevBizDay);
        
        if (alertedCustomers.length > 0) {
            alertArea.innerHTML = '<h4>å‰æ—¥ç•™å®ˆå®…ã‚¢ãƒ©ãƒ¼ãƒˆ</h4>';
            alertedCustomers.forEach(c => {
                const div = document.createElement('div');
                div.className = 'card alert-card';
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div onclick="visitManager.selectCustomerById('${c.id}')" style="cursor:pointer;">
                            <div style="font-weight:bold; color:red;">${c.name}</div>
                            <div style="font-size:0.75rem;">${prevBizDay} ã«ç•™å®ˆã§ã—ãŸ</div>
                        </div>
                        <button class="btn btn-secondary btn-sm" onclick="visitManager.clearAlert('${c.id}')">è§£é™¤</button>
                    </div>
                `;
                alertArea.appendChild(div);
            });
        }
    },

    updateNavAlerts() {
        const dateVal = document.getElementById('entry-date').value;
        const todayStr = dateVal.split('T')[0];
        const prevBizDay = Utils.getPrevBizDay(todayStr);
        const count = Store.data.customers.filter(c => c.isActive && c.absentAlert && c.absentDate === prevBizDay).length;
        const badge = document.getElementById('alert-badge');
        if (count > 0) {
            badge.innerText = count;
            badge.style.display = 'flex';
        } else {
            badge.style.display = 'none';
        }
    },

    clearAlert(cid) {
        const cust = Store.data.customers.find(c => c.id === cid);
        if (cust) {
            cust.absentAlert = false;
            Store.save();
            this.onDateChange();
        }
    },

    filterByDay(day) {
        document.querySelectorAll('.day-chip').forEach(c => {
            c.classList.toggle('active', c.dataset.day === day);
        });
        const input = document.getElementById('entry-customer-search');
        input.value = '';
        this.searchCustomersByDay(day);
    },

    searchCustomersByDay(day) {
        const results = document.getElementById('entry-customer-results');
        results.innerHTML = '';
        const matches = Store.data.customers.filter(c => c.isActive && c.visitDay === day);
        if (matches.length > 0) {
            results.style.display = 'block';
            matches.forEach(c => {
                const div = document.createElement('div');
                div.className = 'customer-option';
                div.innerText = `${c.name} ${c.address ? `(${c.address})` : ''}`;
                div.onclick = () => this.selectCustomerById(c.id);
                results.appendChild(div);
            });
        } else {
            results.style.display = 'none';
        }
    },

    setupCustomerSearch() {
        const input = document.getElementById('entry-customer-search');
        const results = document.getElementById('entry-customer-results');

        input.oninput = () => {
            const val = input.value.trim().toLowerCase();
            results.innerHTML = '';
            if (val.length === 0) {
                const activeDay = document.querySelector('.day-chip.active')?.dataset.day;
                if (activeDay) this.searchCustomersByDay(activeDay);
                return;
            }
            
            const matches = Store.data.customers.filter(c => c.isActive && (c.name.toLowerCase().includes(val) || (c.office && c.office.toLowerCase().includes(val))));
            if (matches.length > 0) {
                results.style.display = 'block';
                matches.forEach(c => {
                    const div = document.createElement('div');
                    const dayMap = { Monday:'æœˆ', Tuesday:'ç«', Wednesday:'æ°´', Thursday:'æœ¨', Friday:'é‡‘', Saturday:'åœŸ', Sunday:'æ—¥' };
                    div.className = 'customer-option';
                    const dayInfo = c.isOnDemand ? 'éƒ½åº¦' : (dayMap[c.visitDay]||'?')+'æ›œ';
                    div.innerText = `${c.name} [${dayInfo}] ${c.office ? `ğŸ¢${c.office}` : ''}`;
                    div.onclick = () => this.selectCustomerById(c.id);
                    results.appendChild(div);
                });
            } else {
                results.style.display = 'none';
            }
        };
        
        document.querySelectorAll('.status-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.status-btn').forEach(b => {
                    b.classList.remove('active', 'btn-primary');
                    b.classList.add('btn-secondary');
                });
                btn.classList.remove('btn-secondary');
                btn.classList.add('active', 'btn-primary');
                
                const status = btn.dataset.val;
                document.getElementById('entry-status').value = status;
                
                const prodSec = document.getElementById('entry-products-section');
                const paySec = document.getElementById('entry-payment-section');
                const totalBar = document.getElementById('entry-total-bar');
                if (status === 'sold') {
                    prodSec.style.display = 'block';
                    paySec.style.display = 'block';
                    document.getElementById('entry-total-info').style.visibility = 'visible';
                } else {
                    prodSec.style.display = 'none';
                    paySec.style.display = 'none';
                    document.getElementById('entry-total-info').style.visibility = 'hidden';
                }
                totalBar.style.display = 'flex';
            };
        });
    },

    selectCustomerById(id) {
        const c = Store.data.customers.find(x => x.id === id);
        if (!c) return;
        const hiddenId = document.getElementById('entry-customer-id');
        const display = document.getElementById('entry-customer-selected-display');
        const nameDisp = document.getElementById('selected-customer-name');
        const memoDisp = document.getElementById('selected-customer-memo');
        const arDisp = document.getElementById('selected-customer-ar');
        const officeDisp = document.getElementById('selected-customer-office');
        const paymentSelect = document.getElementById('entry-payment-method');
        const btnMap = document.getElementById('btn-map-entry');

        hiddenId.value = c.id;
        document.getElementById('entry-customer-results').style.display = 'none';
        nameDisp.innerText = 'é¸æŠä¸­: ' + c.name;
        memoDisp.innerText = c.memo ? 'ãƒ¡ãƒ¢: ' + c.memo : '';
        officeDisp.innerText = c.office ? 'äº‹æ¥­æ‰€: ' + c.office : '';
        
        // æœªé›†é‡‘é¡(å£²æ›)è¨ˆç®—
        let totalSales = 0;
        let totalColl = 0;
        Store.data.visits.filter(v => v.customerId === c.id).forEach(v => {
            if (v.status === 'sold') {
                totalSales += v.items.reduce((s, i) => s + (i.price * i.quantity), 0);
            }
            totalColl += (v.collectionAmount || 0);
        });
        const ar = totalSales - totalColl;
        arDisp.innerText = ar > 0 ? `æœªé›†é‡‘é¡: Â¥${Utils.formatMoney(ar)}` : '';

        display.style.display = 'flex';
        paymentSelect.value = c.defaultPayment || 'cash';
        
        if (c.address) {
            btnMap.style.display = 'inline-flex';
            btnMap.onclick = () => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(c.address)}`);
        } else {
            btnMap.style.display = 'none';
        }
        this.updateTotal();
    },

    renderProductList() {
        const container = document.getElementById('entry-product-list');
        container.innerHTML = '';
        Store.data.products.filter(p => p.isActive).forEach(p => {
            const qty = this.selectedProducts[p.id] || 0;
            const div = document.createElement('div');
            div.className = 'product-list-item';
            div.innerHTML = `
                <div>
                    <div style="font-weight:bold;">${p.name} <span class="badge">${p.category||''}</span></div>
                    <div style="font-size:0.8rem; color:#666;">Â¥${p.price}</div>
                </div>
                <div class="qty-control">
                    <div class="qty-btn" onclick="visitManager.changeQty('${p.id}', -1)">-</div>
                    <div class="qty-val" id="qty-${p.id}">${qty}</div>
                    <div class="qty-btn" onclick="visitManager.changeQty('${p.id}', 1)">+</div>
                </div>
            `;
            container.appendChild(div);
        });
    },

    changeQty(pid, delta) {
        if (!this.selectedProducts[pid]) this.selectedProducts[pid] = 0;
        this.selectedProducts[pid] += delta;
        if (this.selectedProducts[pid] < 0) this.selectedProducts[pid] = 0;
        document.getElementById(`qty-${pid}`).innerText = this.selectedProducts[pid];
        this.updateTotal();
    },

    updateTotal() {
        let total = 0;
        for (const [pid, qty] of Object.entries(this.selectedProducts)) {
            const prod = Store.data.products.find(p => p.id === pid);
            if (prod) total += prod.price * qty;
        }
        document.getElementById('entry-total-price').innerText = Utils.formatMoney(total);
        
        const payMethod = document.getElementById('entry-payment-method').value;
        const collInput = document.getElementById('entry-collection-amount');
        if (payMethod === 'cash' || payMethod === 'paypay' || payMethod === 'credit') {
            collInput.value = total;
        } else {
            collInput.value = 0;
        }
    },

    save() {
        const customerId = document.getElementById('entry-customer-id').value;
        const dateVal = document.getElementById('entry-date').value;
        const status = document.getElementById('entry-status').value;
        const note = document.getElementById('entry-note').value;
        const payMethod = document.getElementById('entry-payment-method').value;
        const collAmount = parseInt(document.getElementById('entry-collection-amount').value) || 0;

        if (!customerId) {
            alert('é¡§å®¢ã‚’é¸æŠã—ã¦ãã ã•ã„');
            return;
        }

        const items = [];
        if (status === 'sold') {
            for (const [pid, qty] of Object.entries(this.selectedProducts)) {
                if (qty > 0) {
                    const prod = Store.data.products.find(p => p.id === pid);
                    items.push({
                        productId: pid,
                        quantity: qty,
                        price: prod.price,
                        category: prod.category
                    });
                }
            }
        }

        const cust = Store.data.customers.find(c => c.id === customerId);
        if (status === 'absent') {
            if (cust) {
                cust.absentAlert = true;
                cust.absentDate = dateVal.split('T')[0];
            }
        } else if (cust) {
            cust.absentAlert = false;
        }

        const visit = {
            id: Store.generateId(),
            timestamp: new Date(dateVal).getTime(),
            dateStr: dateVal.split('T')[0],
            customerId: customerId,
            status: status,
            items: items,
            paymentMethod: status === 'sold' ? payMethod : null,
            collectionAmount: collAmount,
            note: note,
            office: cust ? cust.office : ''
        };

        Store.data.visits.push(visit);
        Store.save();
        alert('ä¿å­˜ã—ã¾ã—ãŸ');
        router.navigate('home');
    },

    reEnter(visit) {
        router.navigate('entry');
        this.selectCustomerById(visit.customerId);

        if (visit.status === 'sold') {
            this.selectedProducts = {};
            visit.items.forEach(i => {
                this.selectedProducts[i.productId] = i.quantity;
            });
            document.getElementById('entry-payment-method').value = visit.paymentMethod;
            this.renderProductList();
            this.updateTotal();
            document.getElementById('entry-collection-amount').value = visit.collectionAmount;
        }
    }
};

/**
 * ãƒã‚¹ã‚¿ç®¡ç†æ©Ÿèƒ½
 */
const masterManager = {
    currentTab: 'customer',

    switchTab(tab) {
        this.currentTab = tab;
        document.getElementById('tab-master-customer').classList.remove('btn-primary', 'btn-secondary');
        document.getElementById('tab-master-product').classList.remove('btn-primary', 'btn-secondary');
        
        document.getElementById('tab-master-customer').classList.add(tab === 'customer' ? 'btn-primary' : 'btn-secondary');
        document.getElementById('tab-master-product').classList.add(tab === 'product' ? 'btn-primary' : 'btn-secondary');

        document.getElementById('master-customer-view').style.display = tab === 'customer' ? 'block' : 'none';
        document.getElementById('master-product-view').style.display = tab === 'product' ? 'block' : 'none';
        
        if (tab === 'customer') this.renderCustomers();
        else this.renderProducts();
    },

    renderCustomers() {
        const list = document.getElementById('master-customer-list');
        const filter = document.getElementById('master-customer-search').value.toLowerCase();
        list.innerHTML = '';
        const dayMap = { Monday:'æœˆ', Tuesday:'ç«', Wednesday:'æ°´', Thursday:'æœ¨', Friday:'é‡‘', Saturday:'åœŸ', Sunday:'æ—¥' };
        
        Store.data.customers.filter(c => c.isActive).forEach(c => {
            if (filter && !c.name.toLowerCase().includes(filter) && !(c.office && c.office.toLowerCase().includes(filter))) return;
            
            const div = document.createElement('div');
            div.className = 'card';
            div.style.marginBottom = '8px';
            const dayLabel = c.isOnDemand ? 'éƒ½åº¦è¨ªå•' : (dayMap[c.visitDay]||'æœªè¨­å®š') + 'æ›œ';
            div.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="font-weight:bold;">${c.name} <span class="badge">${dayLabel}</span></div>
                        <div style="font-size:0.8rem; color:var(--accent-color);">${c.office ? `äº‹æ¥­æ‰€: ${c.office}` : 'ç„¡æ‰€å±'}</div>
                        <div style="font-size:0.8rem; color:#666;">${c.address || '-'} / ${c.phone || '-'}</div>
                        <div style="font-size:0.75rem; color:#888; margin-top:4px;">${c.memo || ''}</div>
                    </div>
                    <div class="list-item-action">
                        ${c.address ? `<button class="btn btn-sm btn-secondary" onclick="window.open('https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(c.address)}')">åœ°å›³</button>` : ''}
                        <button class="btn btn-sm btn-secondary" onclick="masterManager.openModal('customer', '${c.id}')">ç·¨é›†</button>
                    </div>
                </div>
            `;
            list.appendChild(div);
        });
    },

    renderProducts() {
        const list = document.getElementById('master-product-list');
        list.innerHTML = '';
        Store.data.products.filter(p => p.isActive).forEach(p => {
            const div = document.createElement('div');
            div.className = 'card';
            div.style.marginBottom = '8px';
            div.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="font-weight:bold;">${p.name} <span class="badge">${p.category}</span></div>
                        <div style="font-size:0.8rem; color:#666;">Â¥${p.price}</div>
                    </div>
                    <div class="list-item-action">
                        <button class="btn btn-sm btn-secondary" onclick="masterManager.openModal('product', '${p.id}')">ç·¨é›†</button>
                    </div>
                </div>
            `;
            list.appendChild(div);
        });
    },

    openModal(type, id) {
        if (!type) type = this.currentTab;
        const isEdit = !!id;
        const modal = document.getElementById('master-modal');
        const fields = document.getElementById('modal-fields');
        document.getElementById('modal-title').innerText = isEdit ? 'ç·¨é›†' : 'æ–°è¦è¿½åŠ ';
        document.getElementById('modal-type').value = type;
        document.getElementById('modal-id').value = id || '';
        
        fields.innerHTML = '';
        let data = {};

        if (type === 'customer') {
            if (isEdit) data = Store.data.customers.find(c => c.id === id);
            fields.innerHTML = `
                <div class="input-group"><label class="input-label">åå‰</label><input class="form-control" id="m-c-name" value="${data.name||''}"></div>
                <div class="input-group"><label class="input-label">äº‹æ¥­æ‰€ (ã‚ã‚Œã°)</label><input class="form-control" id="m-c-office" value="${data.office||''}" placeholder="ä¾‹: â—‹â—‹å•†äº‹"></div>
                <div class="input-group">
                    <label class="input-label"><input type="checkbox" id="m-c-ondemand" ${data.isOnDemand?'checked':''}> éƒ½åº¦è¨ªå• (æ›œæ—¥å›ºå®šãªã—)</label>
                </div>
                <div class="input-group" id="m-c-day-group" style="${data.isOnDemand?'display:none':''}">
                    <label class="input-label">è¨ªå•æ›œæ—¥</label>
                    <select class="form-control" id="m-c-day">
                        <option value="Monday" ${data.visitDay==='Monday'?'selected':''}>æœˆæ›œæ—¥</option>
                        <option value="Tuesday" ${data.visitDay==='Tuesday'?'selected':''}>ç«æ›œæ—¥</option>
                        <option value="Wednesday" ${data.visitDay==='Wednesday'?'selected':''}>æ°´æ›œæ—¥</option>
                        <option value="Thursday" ${data.visitDay==='Thursday'?'selected':''}>æœ¨æ›œæ—¥</option>
                        <option value="Friday" ${data.visitDay==='Friday'?'selected':''}>é‡‘æ›œæ—¥</option>
                        <option value="Saturday" ${data.visitDay==='Saturday'?'selected':''}>åœŸæ›œæ—¥</option>
                        <option value="Sunday" ${data.visitDay==='Sunday'?'selected':''}>æ—¥æ›œæ—¥</option>
                    </select>
                </div>
                <div class="input-group"><label class="input-label">é›»è©±</label><input class="form-control" id="m-c-phone" value="${data.phone||''}"></div>
                <div class="input-group"><label class="input-label">ä½æ‰€ (Googleãƒãƒƒãƒ—é€£æºç”¨)</label><input class="form-control" id="m-c-addr" value="${data.address||''}"></div>
                <div class="input-group"><label class="input-label">æ—¢å®šã®æ”¯æ‰•æ–¹æ³•</label>
                    <select class="form-control" id="m-c-pay">
                        <option value="cash" ${data.defaultPayment==='cash'?'selected':''}>ç¾é‡‘</option>
                        <option value="paypay" ${data.defaultPayment==='paypay'?'selected':''}>PayPay</option>
                        <option value="credit" ${data.defaultPayment==='credit'?'selected':''}>ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ</option>
                        <option value="prepaid" ${data.defaultPayment==='prepaid'?'selected':''}>å‰æ‰•ã„æ¶ˆåŒ–</option>
                        <option value="monthly" ${data.defaultPayment==='monthly'?'selected':''}>å£²æ›(æœˆæœ«æœˆæ¥µ)</option>
                    </select>
                </div>
                <div class="input-group"><label class="input-label">é…é”ãƒ¡ãƒ¢ (ç½®é…å ´æ‰€ãªã©)</label><textarea class="form-control" id="m-c-memo" rows="2">${data.memo||''}</textarea></div>
            `;
            setTimeout(() => {
                const cb = document.getElementById('m-c-ondemand');
                cb.onchange = () => { document.getElementById('m-c-day-group').style.display = cb.checked ? 'none' : 'block'; };
            }, 0);
        } else {
            if (isEdit) data = Store.data.products.find(p => p.id === id);
            fields.innerHTML = `
                <div class="input-group"><label class="input-label">å•†å“å</label><input class="form-control" id="m-p-name" value="${data.name||''}"></div>
                <div class="input-group"><label class="input-label">ä¾¡æ ¼</label><input type="number" class="form-control" id="m-p-price" value="${data.price||''}"></div>
                <div class="input-group"><label class="input-label">ã‚«ãƒ†ã‚´ãƒª</label>
                    <select class="form-control" id="m-p-cat">
                        <option value="Y400" ${data.category==='Y400'?'selected':''}>Y400é¡</option>
                        <option value="Y1000" ${data.category==='Y1000'?'selected':''}>Y1000é¡</option>
                        <option value="OTHER" ${data.category==='OTHER'?'selected':''}>ãã®ä»–</option>
                    </select>
                </div>
            `;
        }
        modal.style.display = 'flex';
    },

    closeModal() {
        document.getElementById('master-modal').style.display = 'none';
    },

    saveFromModal() {
        const type = document.getElementById('modal-type').value;
        const id = document.getElementById('modal-id').value;
        
        if (type === 'customer') {
            const name = document.getElementById('m-c-name').value;
            const office = document.getElementById('m-c-office').value;
            const isOnDemand = document.getElementById('m-c-ondemand').checked;
            const phone = document.getElementById('m-c-phone').value;
            const addr = document.getElementById('m-c-addr').value;
            const day = document.getElementById('m-c-day').value;
            const pay = document.getElementById('m-c-pay').value;
            const memo = document.getElementById('m-c-memo').value;
            if (!name) return alert('åå‰ã¯å¿…é ˆã§ã™');

            if (id) {
                const c = Store.data.customers.find(x => x.id === id);
                c.name = name; c.office = office; c.isOnDemand = isOnDemand; c.phone = phone; c.address = addr; c.visitDay = day; c.defaultPayment = pay; c.memo = memo;
            } else {
                Store.data.customers.push({
                    id: Store.generateId(), name, office, isOnDemand, phone, address: addr, visitDay: day, defaultPayment: pay, memo, isActive: true
                });
            }
        } else {
            const name = document.getElementById('m-p-name').value;
            const price = parseInt(document.getElementById('m-p-price').value);
            const cat = document.getElementById('m-p-cat').value;
            if (!name || isNaN(price)) return alert('æ­£ã—ã„å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');

            if (id) {
                const p = Store.data.products.find(x => x.id === id);
                p.name = name; p.price = price; p.category = cat;
            } else {
                Store.data.products.push({
                    id: Store.generateId(), name, price, category: cat, isActive: true
                });
            }
        }
        Store.save();
        this.closeModal();
        if (type === 'customer') this.renderCustomers();
        else this.renderProducts();
    }
};

/**
 * ãƒ¬ãƒãƒ¼ãƒˆæ©Ÿèƒ½
 */
const reportManager = {
    reportType: 'day',

    init() {
        const now = new Date();
        document.getElementById('report-date').value = now.toISOString().split('T')[0];
        document.getElementById('report-month').value = now.toISOString().slice(0, 7);
        this.render();
    },

    setType(type) {
        this.reportType = type;
        document.querySelectorAll('.rep-type-btn').forEach(b => {
            b.classList.remove('btn-primary', 'btn-secondary');
            b.classList.add(b.dataset.type === type ? 'btn-primary' : 'btn-secondary');
        });
        document.getElementById('report-date').style.display = (type === 'day' || type === 'week') ? 'block' : 'none';
        document.getElementById('report-month').style.display = (type === 'month') ? 'block' : 'none';
        this.render();
    },

    render() {
        const dateVal = document.getElementById('report-date').value;
        const monthVal = document.getElementById('report-month').value;
        const staffName = Store.data.settings.staffName;
        document.getElementById('report-staff-name').innerText = staffName;

        let targetVisits = [];
        let titleLabel = '';

        if (this.reportType === 'day') {
            targetVisits = Store.data.visits.filter(v => v.dateStr === dateVal);
            titleLabel = dateVal;
        } else if (this.reportType === 'week') {
            const range = Utils.getWeekRange(dateVal);
            targetVisits = Store.data.visits.filter(v => v.dateStr >= range.start && v.dateStr <= range.end);
            titleLabel = `${range.start} ã€œ ${range.end}`;
        } else {
            targetVisits = Store.data.visits.filter(v => v.dateStr.startsWith(monthVal));
            titleLabel = monthVal;
        }
        document.getElementById('report-title-label').innerText = titleLabel;

        let totalSales = 0;
        let totalCollections = 0;
        const payStats = { cash: { sales: 0, coll: 0 }, paypay: { sales: 0, coll: 0 }, credit: { sales: 0, coll: 0 }, prepaid: { sales: 0, coll: 0 }, monthly: { sales: 0, coll: 0 } };
        const productStats = {};
        const customerStats = {};
        
        // æœˆæ¬¡çµ±è¨ˆç”¨
        const dayStats = { Monday: {v:0, m:0, o:0, n:0}, Tuesday: {v:0, m:0, o:0, n:0}, Wednesday: {v:0, m:0, o:0, n:0}, Thursday: {v:0, m:0, o:0, n:0}, Friday: {v:0, m:0, o:0, n:0}, Saturday: {v:0, m:0, o:0, n:0}, Sunday: {v:0, m:0, o:0, n:0} };
        const catStats = { Y400: { m:0, o:0 }, Y1000: { m:0, o:0 } };
        const officeStats = {};

        targetVisits.forEach(v => {
            if (!customerStats[v.customerId]) customerStats[v.customerId] = { name: '', sales: 0, coll: 0 };
            const cust = Store.data.customers.find(c => c.id === v.customerId);
            const cName = cust ? cust.name : 'ä¸æ˜';
            const cOffice = cust ? (cust.office || 'ç„¡æ‰€å±') : 'ä¸æ˜';
            customerStats[v.customerId].name = cName;
            customerStats[v.customerId].coll += (v.collectionAmount || 0);
            totalCollections += (v.collectionAmount || 0);

            // æœˆæ¬¡ç”¨é›†è¨ˆ
            if (this.reportType === 'month' && cust) {
                const day = Utils.getDayName(v.dateStr);
                dayStats[day].v++;
                if (v.status === 'sold') {
                    if (v.paymentMethod === 'monthly') dayStats[day].m++; else dayStats[day].o++;
                } else {
                    dayStats[day].n++;
                }

                if (!officeStats[cOffice]) officeStats[cOffice] = { v:0, m:0, cash:0, pp:0, y400:0, y1000:0 };
                officeStats[cOffice].v++;
                if (v.status === 'sold') {
                    if (v.paymentMethod === 'monthly') officeStats[cOffice].m++;
                    if (v.paymentMethod === 'cash') officeStats[cOffice].cash++;
                    if (v.paymentMethod === 'paypay') officeStats[cOffice].pp++;
                }
            }

            if (v.status === 'sold') {
                const subtotal = v.items.reduce((s, i) => s + (i.price * i.quantity), 0);
                totalSales += subtotal;
                customerStats[v.customerId].sales += subtotal;

                if (v.paymentMethod && payStats[v.paymentMethod]) {
                    payStats[v.paymentMethod].sales += subtotal;
                    payStats[v.paymentMethod].coll += (v.collectionAmount || 0);
                }

                v.items.forEach(item => {
                    if (!productStats[item.productId]) productStats[item.productId] = { qty: 0, amount: 0 };
                    productStats[item.productId].qty += item.quantity;
                    productStats[item.productId].amount += (item.price * item.quantity);
                    
                    if (this.reportType === 'month') {
                        const cat = item.category;
                        if (cat === 'Y400' || cat === 'Y1000') {
                            if (v.paymentMethod === 'monthly') catStats[cat].m++; else catStats[cat].o++;
                        }
                        if (cust) {
                            const cOffice = cust.office || 'ç„¡æ‰€å±';
                            if (cat === 'Y400') officeStats[cOffice].y400 += item.quantity;
                            if (cat === 'Y1000') officeStats[cOffice].y1000 += item.quantity;
                        }
                    }
                });
            }
        });

        document.getElementById('rep-visit-count').innerText = targetVisits.length;
        document.getElementById('rep-total-sales').innerText = Utils.formatMoney(totalSales);
        document.getElementById('rep-total-collections').innerText = Utils.formatMoney(totalCollections);

        // æœˆæ¬¡è¿½åŠ ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤º
        if (this.reportType === 'month') {
            document.getElementById('rep-monthly-extra').style.display = 'block';
            const dayBody = document.querySelector('#rep-day-stat-table tbody');
            const dayMap = { Monday:'æœˆ', Tuesday:'ç«', Wednesday:'æ°´', Thursday:'æœ¨', Friday:'é‡‘', Saturday:'åœŸ', Sunday:'æ—¥' };
            dayBody.innerHTML = '';
            Object.keys(dayStats).forEach(k => {
                if (dayStats[k].v > 0) dayBody.innerHTML += `<tr><td>${dayMap[k]}æ›œ</td><td>${dayStats[k].v}</td><td>${dayStats[k].m}</td><td>${dayStats[k].o}</td><td>${dayStats[k].n}</td></tr>`;
            });
            
            const catBody = document.querySelector('#rep-cat-stat-table tbody');
            catBody.innerHTML = `
                <tr><td>Y400é¡</td><td>${catStats.Y400.m}ä»¶</td><td>${catStats.Y400.o}ä»¶</td></tr>
                <tr><td>Y1000é¡</td><td>${catStats.Y1000.m}ä»¶</td><td>${catStats.Y1000.o}ä»¶</td></tr>
            `;

            const offBody = document.querySelector('#rep-office-table tbody');
            offBody.innerHTML = '';
            Object.keys(officeStats).forEach(off => {
                const s = officeStats[off];
                offBody.innerHTML += `<tr><td>${off}</td><td>${s.v}</td><td>${s.m}</td><td>${s.cash}</td><td>${s.pp}</td><td>${s.y400}</td><td>${s.y1000}</td></tr>`;
            });
        } else {
            document.getElementById('rep-monthly-extra').style.display = 'none';
        }

        const payBody = document.querySelector('#rep-pay-table tbody');
        const payNameMap = { cash:'ç¾é‡‘', paypay:'PayPay', credit:'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ', prepaid:'å‰æ‰•ã„æ¶ˆåŒ–', monthly:'å£²æ›(æœˆæœ«æœˆæ¥µ)' };
        payBody.innerHTML = '';
        Object.keys(payStats).forEach(k => {
            if (payStats[k].sales > 0 || payStats[k].coll > 0) {
                payBody.innerHTML += `<tr><td>${payNameMap[k]}</td><td class="text-right">Â¥${Utils.formatMoney(payStats[k].sales)}</td><td class="text-right">Â¥${Utils.formatMoney(payStats[k].coll)}</td></tr>`;
            }
        });

        const prodBody = document.querySelector('#rep-prod-table tbody');
        prodBody.innerHTML = '';
        Object.keys(productStats).forEach(pid => {
            const p = Store.data.products.find(x => x.id === pid) || { name:'å‰Šé™¤å“' };
            prodBody.innerHTML += `<tr><td>${p.name}</td><td class="text-right">${productStats[pid].qty}</td><td class="text-right">Â¥${Utils.formatMoney(productStats[pid].amount)}</td></tr>`;
        });

        const custBody = document.querySelector('#rep-cust-table tbody');
        custBody.innerHTML = '';
        Object.values(customerStats).sort((a,b) => b.sales - a.sales).forEach(c => {
            custBody.innerHTML += `<tr><td>${c.name}</td><td class="text-right">Â¥${Utils.formatMoney(c.sales)}</td><td class="text-right">Â¥${Utils.formatMoney(c.coll)}</td></tr>`;
        });
    },

    exportCSV() {
        const title = document.getElementById('report-title-label').innerText;
        let csv = '\uFEFF'; 
        csv += "æ—¥ä»˜,é¡§å®¢å,äº‹æ¥­æ‰€,ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹,æ”¯æ‰•æ–¹æ³•,è²©å£²é¡,é›†é‡‘é¡,ãƒ¡ãƒ¢\n";
        
        const dateVal = document.getElementById('report-date').value;
        const monthVal = document.getElementById('report-month').value;
        let targetVisits = [];
        if (this.reportType === 'day') targetVisits = Store.data.visits.filter(v => v.dateStr === dateVal);
        else if (this.reportType === 'week') {
            const range = Utils.getWeekRange(dateVal);
            targetVisits = Store.data.visits.filter(v => v.dateStr >= range.start && v.dateStr <= range.end);
        } else targetVisits = Store.data.visits.filter(v => v.dateStr.startsWith(monthVal));

        targetVisits.forEach(v => {
            const cust = Store.data.customers.find(c => c.id === v.customerId);
            const sales = v.items.reduce((s, i) => s + (i.price * i.quantity), 0);
            csv += `"${v.dateStr}","${cust?cust.name:'ä¸æ˜'}","${cust?cust.office:''}","${v.status}","${v.paymentMethod||''}","${sales}","${v.collectionAmount}","${v.note||''}"\n`;
        });

        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `report_${title}.csv`;
        a.click();
    }
};

/**
 * è¨­å®šæ©Ÿèƒ½
 */
const settingsManager = {
    init() {
        document.getElementById('setting-staff-name').value = Store.data.settings.staffName || '';
    },
    saveBasic() {
        Store.data.settings.staffName = document.getElementById('setting-staff-name').value;
        Store.save();
        alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
    },
    exportData() {
        const json = JSON.stringify(Store.data, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `sales_assist_backup_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
    },
    importData(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                if (confirm('ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ')) {
                    Store.data = data;
                    Store.save();
                    location.reload();
                }
            } catch (err) { alert('ä¸æ­£ãªãƒ•ã‚¡ã‚¤ãƒ«ã§ã™'); }
        };
        reader.readAsText(file);
    },
    clearAllData() {
        if (confirm('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ')) {
            Store.data = {
                customers: [],
                products: [],
                visits: [],
                settings: { staffName: 'æ‹…å½“è€…' }
            };
            Store.save();
            localStorage.removeItem(Store.key);
            location.reload();
        }
    }
};

document.addEventListener('DOMContentLoaded', async () => {
    await Store.init();
    const now = new Date();
    document.getElementById('header-date').innerText = `${now.getMonth()+1}/${now.getDate()}`;
    router.navigate('home');
});
</script>
</body>
</html>